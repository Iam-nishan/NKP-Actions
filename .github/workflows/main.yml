name: Build Custom Kernel with KernelSU

on:
  workflow_dispatch:
    inputs:
      kernel_repo:
        description: 'Kernel source repository (format: owner/repo)'
        required: true
        type: string
      kernel_branch:
        description: 'Kernel source branch'
        required: true
        default: 'main'
        type: string
      device_codename:
        description: 'Device codename'
        required: true
        type: string
      defconfig:
        description: 'Defconfig name'
        required: true
        type: string
      arch:
        description: 'Architecture'
        required: true
        default: 'arm64'
        type: choice
        options: [arm64, arm]
      compiler:
        description: 'Compiler toolchain'
        required: true
        default: 'clang'
        type: choice
        options: [clang, gcc, proton-clang]
      enable_kernelsu:
        description: 'Integrate KernelSU Next'
        required: true
        default: true
        type: boolean

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - uses: easimon/maximize-build-space@master
      with:
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'
        remove-docker-images: 'true'

    - name: Checkout kernel
      run: |
        git clone --depth=1 --branch ${{ github.event.inputs.kernel_branch }} \
          https://github.com/${{ github.event.inputs.kernel_repo }} kernel
        cd kernel
        git submodule update --init --recursive --depth=1 || true

    - name: Setup build dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          bc bison build-essential ccache curl flex \
          g++-multilib gcc-multilib git gnupg gperf \
          lib32readline-dev lib32z1-dev libelf-dev \
          libssl-dev lzop rsync unzip zip zlib1g-dev \
          llvm clang wget

    - name: Build & install Python 2.7
      run: |
        cd /tmp
        wget https://www.python.org/ftp/python/2.7.18/Python-2.7.18.tgz
        tar -xf Python-2.7.18.tgz
        cd Python-2.7.18
        ./configure
        make -j$(nproc)
        sudo make altinstall
        sudo ln -sf /usr/local/bin/python2.7 /usr/bin/python
        python --version

    - name: Setup toolchain
      run: |
        mkdir -p ~/toolchains
        cd ~/toolchains
        if [ "${{ github.event.inputs.compiler }}" = "clang" ]; then
          git clone --depth=1 https://github.com/llvm/llvm-project clang
          echo "CLANG_PATH=$HOME/toolchains/clang" >> $GITHUB_ENV
        elif [ "${{ github.event.inputs.compiler }}" = "proton-clang" ]; then
          git clone --depth=1 https://github.com/kdrag0n/proton-clang clang
          echo "CLANG_PATH=$HOME/toolchains/clang" >> $GITHUB_ENV
        else
          git clone --depth=1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_aarch64_aarch64-linux-android-4.9 gcc-aarch64
          git clone --depth=1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_arm_arm-linux-androideabi-4.9 gcc-arm
          echo "GCC_AARCH64=$HOME/toolchains/gcc-aarch64" >> $GITHUB_ENV
          echo "GCC_ARM=$HOME/toolchains/gcc-arm" >> $GITHUB_ENV
        fi

    - name: Integrate KernelSU Next
      if: ${{ github.event.inputs.enable_kernelsu }}
      continue-on-error: true
      run: |
        cd kernel
        curl -LSs https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh | bash -

    - name: Configure kernel
      run: |
        cd kernel
        export ARCH=${{ github.event.inputs.arch }}
        export SUBARCH=$ARCH
        if [ "${{ github.event.inputs.compiler }}" = "gcc" ]; then
          export CROSS_COMPILE=$GCC_AARCH64/bin/aarch64-linux-android-
          export CROSS_COMPILE_ARM32=$GCC_ARM/bin/arm-linux-androideabi-
        else
          export PATH=$CLANG_PATH/bin:$PATH
          export CC=clang
          export LLVM=1
          export LLVM_IAS=1
        fi
        make O=out ${{ github.event.inputs.defconfig }}

    - name: Build kernel
      run: |
        cd kernel
        make O=out -j$(nproc)

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-${{ github.event.inputs.device_codename }}
        path: kernel/out/arch/**/boot/*
