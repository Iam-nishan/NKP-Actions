name: Build Custom Kernel with KernelSU

on:
  workflow_dispatch:
    inputs:
      kernel_repo:
        description: 'Kernel source repository (format: owner/repo)'
        required: true
        type: string
      kernel_branch:
        description: 'Kernel source branch'
        required: true
        default: 'main'
        type: string
      device_codename:
        description: 'Device codename (e.g., marble, raphael)'
        required: true
        type: string
      defconfig:
        description: 'Defconfig name (e.g., vendor/marble_defconfig)'
        required: true
        type: string
      arch:
        description: 'Architecture'
        required: true
        default: 'arm64'
        type: choice
        options:
          - arm64
          - arm
      compiler:
        description: 'Compiler toolchain'
        required: true
        default: 'clang'
        type: choice
        options:
          - clang
          - gcc
          - proton-clang
      enable_kernelsu:
        description: 'Integrate KernelSU Next'
        required: true
        default: true
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Maximize build space
      uses: easimon/maximize-build-space@master
      with:
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'
        remove-docker-images: 'true'

    - name: Checkout kernel source
      run: |
        git clone --depth=1 --branch ${{ github.event.inputs.kernel_branch }} \
          https://github.com/${{ github.event.inputs.kernel_repo }} kernel
        cd kernel
        git submodule update --init --recursive || true

    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          bc bison build-essential ccache curl flex \
          g++-multilib gcc-multilib git gnupg gperf \
          imagemagick lib32readline-dev lib32z1-dev \
          liblz4-tool libsdl1.2-dev libssl-dev libxml2 \
          libxml2-utils lzop pngcrush rsync schedtool \
          squashfs-tools xsltproc zip zlib1g-dev \
          libelf-dev software-properties-common

    # ===== PYTHON2 FIX (ONLY CHANGE) =====
    - name: Install Python2 (MTK fix)
      run: |
        sudo apt update
        sudo apt install -y python2-minimal || true

        if ! command -v python2; then
          sudo apt install -y build-essential wget
          cd /tmp
          wget https://www.python.org/ftp/python/2.7.18/Python-2.7.18.tgz
          tar xf Python-2.7.18.tgz
          cd Python-2.7.18
          ./configure
          make -j$(nproc)
          sudo make altinstall
        fi

        sudo ln -sf /usr/local/bin/python2.7 /usr/bin/python2
        sudo ln -sf /usr/local/bin/python2.7 /usr/bin/python
        python2 --version
    # ====================================

    - name: Setup compiler toolchain
      run: |
        mkdir -p ~/toolchains
        cd ~/toolchains

        if [ "${{ github.event.inputs.compiler }}" = "clang" ]; then
          git clone --depth=1 https://github.com/kdrag0n/proton-clang clang
          echo "CLANG_PATH=$HOME/toolchains/clang" >> $GITHUB_ENV
        fi

    - name: Integrate KernelSU Next
      if: ${{ github.event.inputs.enable_kernelsu }}
      run: |
        cd kernel
        curl -LSs https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh | bash - || true
        make mrproper

    - name: Configure kernel
      run: |
        cd kernel
        export ARCH=${{ github.event.inputs.arch }}
        export SUBARCH=${{ github.event.inputs.arch }}
        export HOSTCC=gcc
        export HOSTCXX=g++
        make O=out ${{ github.event.inputs.defconfig }}

    - name: Build kernel
      run: |
        cd kernel
        export ARCH=${{ github.event.inputs.arch }}        
        export HOSTCC=gcc
        export HOSTCXX=g++
        make -j$(nproc) O=out

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-${{ github.event.inputs.device_codename }}
        path: kernel/out/arch/${{ github.event.inputs.arch }}/boot/*
